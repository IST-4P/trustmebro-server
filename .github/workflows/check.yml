name: CI/CD - Detect Affected Apps (Nx 19+)

on:
  push:
    branches:
      - sauvole565
  pull_request:
    branches:
      - sauvole565

permissions:
  actions: read
  contents: read

jobs:
  detect-affected:
    runs-on: ubuntu-latest
    outputs:
      affected-apps: ${{ steps.affected.outputs.apps }}
    steps:
      # ‚≠ê STEP 1: Checkout with full history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # QUAN TR·ªåNG: Full git history to detect affected

      # ‚≠ê STEP 2: Setup pnpm
      - uses: pnpm/action-setup@v4
        with:
          version: 9

      # ‚≠ê STEP 3: Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      # ‚≠ê STEP 4: Configure Git
      - name: Configure Git protocol
        run: git config --global url."https://github.com/".insteadOf git://github.com/

      # ‚≠ê STEP 5: Cache pnpm
      - name: Cache pnpm store
        id: cache-pnpm-store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ‚≠ê STEP 6: Install dependencies
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ‚≠ê STEP 7: DETECT AFFECTED APPS (Nx 19+ Fix)
      - name: Detect affected apps using Nx 19+
        id: affected
        run: |
          # Nx 19+ command: Use 'nx show projects --affected'
          # This replaces the old 'nx print-affected' command
          AFFECTED=""

          # Try Nx command first
          if npx nx --version >/dev/null 2>&1; then
            echo "‚úì Nx detected, using 'nx show projects --affected'"
            AFFECTED=$(npx nx show projects --affected --base=origin/sauvole565 2>/dev/null | tr '\n' ',' | sed 's/,$//')
          fi

          # If Nx failed or not available, fallback to git diff
          if [ -z "$AFFECTED" ]; then
            echo "‚ö†Ô∏è  Falling back to git diff method"
            # Get changed files in apps/services and apps/bffs directories
            APPS=$(git diff --name-only origin/sauvole565...HEAD | grep -E '^apps/(services|bffs)/' | awk -F'/' '{print $3}' | sort -u)
            AFFECTED=$(echo "$APPS" | paste -sd, -)
          fi

          echo "apps=$AFFECTED" >> $GITHUB_OUTPUT
          echo "Detected apps: [$AFFECTED]"

      # ‚≠ê STEP 8: LOG AFFECTED APPS (MAIN PURPOSE)
      - name: Log affected apps
        run: |
          AFFECTED="${{ steps.affected.outputs.apps }}"

          echo ""
          echo "=========================================="
          echo "üì¶ AFFECTED APPS DETECTION"
          echo "=========================================="
          echo "Branch: sauvole565"
          echo "Comparing: origin/sauvole565 vs HEAD"
          echo ""

          if [ -z "$AFFECTED" ]; then
            echo "‚ùå No apps affected"
            echo "   Only config/docs/CI files changed"
          else
            TOTAL=$(echo "$AFFECTED" | tr ',' '\n' | grep -v '^$' | wc -l)
            echo "‚úÖ $TOTAL app(s) affected:"
            echo ""
            echo "$AFFECTED" | tr ',' '\n' | while read -r app; do
              if [ ! -z "$app" ]; then
                echo "   üì± $app"
              fi
            done
          fi

          echo ""
          echo "=========================================="

      # ‚≠ê STEP 9: Detailed summary
      - name: Detailed affected apps summary
        run: |
          AFFECTED="${{ steps.affected.outputs.apps }}"

          if [ -z "$AFFECTED" ]; then
            echo ""
            echo "‚è≠Ô∏è  Skipping: No apps to build"
          else
            echo ""
            echo "üìä DETAILED REPORT"
            echo ""
            echo "Affected Apps:"
            echo "$AFFECTED" | tr ',' '\n' | grep -v '^$' | nl
            echo ""
            echo "Total Count: $(echo "$AFFECTED" | tr ',' '\n' | grep -v '^$' | wc -l)"
          fi

      # ‚≠ê STEP 10: Show git diff for reference
      - name: Show changed files (for reference)
        run: |
          echo ""
          echo "Changed files in this push:"
          echo "================================================"
          git diff --name-only origin/sauvole565...HEAD | head -20

          TOTAL_CHANGED=$(git diff --name-only origin/sauvole565...HEAD | wc -l)
          if [ $TOTAL_CHANGED -gt 20 ]; then
            echo "... and $((TOTAL_CHANGED - 20)) more files"
          fi
          echo "================================================"
          echo ""
