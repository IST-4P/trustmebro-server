name: Sync Coolify env mappings (Only if .env.example changed)

on:
  push:
    branches: [sauvole565]
  pull_request:
    branches: [sauvole565]

permissions:
  actions: read
  contents: read

jobs:
  # ==================== JOB 1: CHECK IF .env.example CHANGED ====================
  check-env-changes:
    runs-on: ubuntu-latest
    outputs:
      env_modified: ${{ steps.check-env.outputs.env_modified }}
    steps:
      # ‚≠ê Step 1: Checkout with full history (IMPORTANT for git diff)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ‚≠ê CRITICAL: Get full git history to compare branches

      # ‚≠ê Step 2: Check if .env.example was modified using git diff
      - name: Check if .env.example modified
        id: check-env
        run: |
          echo "üîç Checking if .env.example was modified..."
          echo "   Comparing: origin/sauvole565...HEAD"
          echo ""

          # Git diff method (works for push & PR)
          # grep -q: quiet mode (no output, just exit code)
          # ^\.env\.example$: exact match at root (not in subfolder)
          if git diff origin/sauvole565...HEAD --name-only | grep -q "^\.env\.example$"; then
            echo "‚úÖ .env.example WAS MODIFIED - Will sync all apps"
            echo "env_modified=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  .env.example NOT modified - Skipping sync"
            echo "env_modified=false" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "Changed files (for reference):"
          echo "==============================="
          git diff origin/sauvole565...HEAD --name-only | head -10
          echo "==============================="

  # ==================== JOB 2: SYNC TO COOLIFY (Only if .env.example changed) ====================
  sync:
    runs-on: ubuntu-latest
    needs: check-env-changes

    # ‚≠ê CRITICAL: Only run this job if .env.example was modified
    if: needs.check-env-changes.outputs.env_modified == 'true'

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: admin
            secret: COOLIFY_APP_ADMIN
          - name: web
            secret: COOLIFY_APP_WEB
          - name: cart
            secret: COOLIFY_APP_CART
          - name: chat
            secret: COOLIFY_APP_CHAT
          - name: media
            secret: COOLIFY_APP_MEDIA
          - name: notification
            secret: COOLIFY_APP_NOTIFICATION
          - name: order
            secret: COOLIFY_APP_ORDER
          - name: payment
            secret: COOLIFY_APP_PAYMENT
          - name: product
            secret: COOLIFY_APP_PRODUCT
          - name: query
            secret: COOLIFY_APP_QUERY
          - name: role
            secret: COOLIFY_APP_ROLE
          - name: user-access
            secret: COOLIFY_APP_USER_ACCESS

    steps:
      # ‚≠ê Step 1: Checkout
      - uses: actions/checkout@v4

      # ‚≠ê Step 2: Build bulk env JSON payload
      - name: Build bulk env JSON payload
        run: |
          python3 - <<'PY'
          import json, re

          src = ".env.example"
          data = []

          with open(src, "r", encoding="utf-8", newline="") as f:
            for raw in f:
              line = raw.strip()
              # Skip empty lines and comments
              if not line or line.startswith("#") or "=" not in line:
                continue
              key, value = line.split("=", 1)
              key = re.sub(r"^export\s+", "", key).strip()

              data.append({
                "key": key,
                "value": value,
                "is_preview": False,
                "is_literal": False,
                "is_multiline": False,
                "is_shown_once": False
              })

          with open("coolify.bulk.json", "w", encoding="utf-8") as out:
            json.dump({"data": data}, out, ensure_ascii=False)

          print(f"‚úÖ Prepared {len(data)} envs -> coolify.bulk.json")
          PY

      # ‚≠ê Step 3: Sync to Coolify API
      - name: Sync to app (Coolify API bulk)
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.COOLIFY_URL }}/api/v1/applications/${{ secrets[matrix.secret] }}/envs/bulk
          method: PATCH
          bearerToken: ${{ secrets.COOLIFY_API_TOKEN }}
          contentType: application/json
          file: coolify.bulk.json
          retry: 3
          retryWait: 5000

      # ‚≠ê Step 4: Log sync status
      - name: Log sync status
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ Synced .env.example to app: ${{ matrix.name }}"
          echo "   Secret: ${{ matrix.secret }}"
          echo "=========================================="
          echo ""
