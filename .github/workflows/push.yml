name: Sync Coolify env mappings

on:
  push:
    branches: [sauvole565]
  pull_request:

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: admin # service name
            secret: COOLIFY_APP_ADMIN
          - name: web
            secret: COOLIFY_APP_WEB
          - name: cart
            secret: COOLIFY_APP_CART
          - name: chat
            secret: COOLIFY_APP_CHAT
          - name: media
            secret: COOLIFY_APP_MEDIA
          - name: notification
            secret: COOLIFY_APP_NOTIFICATION
          - name: order
            secret: COOLIFY_APP_ORDER
          - name: payment
            secret: COOLIFY_APP_PAYMENT
          - name: product
            secret: COOLIFY_APP_PRODUCT
          - name: query
            secret: COOLIFY_APP_QUERY
          - name: role
            secret: COOLIFY_APP_ROLE
          - name: user-access
            secret: COOLIFY_APP_USER_ACCESS

    steps:
      - uses: actions/checkout@v4

      - name: Build bulk env JSON payload
        run: |
          python3 - <<'PY'
          import json, re

          src = ".env.example"
          data = []

          with open(src, "r", encoding="utf-8", newline="") as f:
            for raw in f:
              line = raw.strip()
              if not line or line.startswith("#") or "=" not in line:
                continue
              key, value = line.split("=", 1)
              key = re.sub(r"^export\s+", "", key).strip()

              data.append({
                "key": key,
                "value": value,
                "is_preview": False,
                "is_literal": True,
                "is_multiline": False,
                "is_shown_once": False
              })

          with open("coolify.bulk.json", "w", encoding="utf-8") as out:
            json.dump({"data": data}, out, ensure_ascii=False)

          print(f"Prepared {len(data)} envs -> coolify.bulk.json")
          PY

      - name: Sync to app (Coolify API bulk)
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.COOLIFY_URL }}/api/v1/applications/${{ secrets[matrix.secret] }}/envs/bulk
          method: PATCH
          bearerToken: ${{ secrets.COOLIFY_API_TOKEN }}
          contentType: application/json
          file: coolify.bulk.json
