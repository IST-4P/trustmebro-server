name: Sync Coolify env mappings

on:
  push:
    branches:
      - sauvole565
  pull_request:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          matrix=$(jq -n \
            --arg admin "${{ secrets.COOLIFY_APP_ADMIN }}" \
            --arg web "${{ secrets.COOLIFY_APP_WEB }}" \
            --arg cart "${{ secrets.COOLIFY_APP_CART }}" \
            --arg chat "${{ secrets.COOLIFY_APP_CHAT }}" \
            --arg media "${{ secrets.COOLIFY_APP_MEDIA }}" \
            --arg notification "${{ secrets.COOLIFY_APP_NOTIFICATION }}" \
            --arg order "${{ secrets.COOLIFY_APP_ORDER }}" \
            --arg payment "${{ secrets.COOLIFY_APP_PAYMENT }}" \
            --arg product "${{ secrets.COOLIFY_APP_PRODUCT }}" \
            --arg query "${{ secrets.COOLIFY_APP_QUERY }}" \
            --arg role "${{ secrets.COOLIFY_APP_ROLE }}" \
            --arg useraccess "${{ secrets.COOLIFY_APP_USER_ACCESS }}" \
            '{
              service: [
                {name: "admin", uuid: $admin},
                {name: "web", uuid: $web},
                {name: "cart", uuid: $cart},
                {name: "chat", uuid: $chat},
                {name: "media", uuid: $media},
                {name: "notification", uuid: $notification},
                {name: "order", uuid: $order},
                {name: "payment", uuid: $payment},
                {name: "product", uuid: $product},
                {name: "query", uuid: $query},
                {name: "role", uuid: $role},
                {name: "user-access", uuid: $useraccess}
              ] | map(select(.uuid != ""))
            }')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  sync:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare env mapping file
        run: |
          set -euo pipefail
          sed 's/\r$//' .env.example > coolify.shared.env

      - name: Build bulk env JSON payload
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, re

          path = "coolify.shared.env"
          data = []
          with open(path, "r", encoding="utf-8") as f:
            for raw in f.read().splitlines():
              line = raw.strip()
              if not line or line.startswith("#"):
                continue
              if "=" not in line:
                continue

              key, value = line.split("=", 1)

              # strip optional "export "
              key = re.sub(r"^export\s+", "", key).strip()

              # keep value as-is (no unquoting); Coolify handles literal values
              is_multiline = "\n" in value

              data.append({
                "key": key,
                "value": value,
                "is_preview": False,
                "is_literal": True,
                "is_multiline": is_multiline,
                "is_shown_once": False
              })

          payload = {"data": data}
          with open("coolify.bulk.json", "w", encoding="utf-8") as out:
            json.dump(payload, out, ensure_ascii=False)

          print(f"Prepared {len(data)} envs -> coolify.bulk.json")
          PY

      - name: Sync to all apps (via Coolify API)
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.COOLIFY_URL }}/api/v1/applications/${{ matrix.service.uuid }}/envs/bulk
          method: PATCH
          bearerToken: ${{ secrets.COOLIFY_API_TOKEN }}
          contentType: application/json
          file: coolify.bulk.json
