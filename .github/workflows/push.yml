name: Sync Coolify env mappings

on:
  push:
    branches:
      - sauvole565
  pull_request:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare env mapping file
        run: |
          set -euo pipefail
          sed 's/\r$//' .env.example > coolify.shared.env

      - name: Build bulk env JSON payload
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, re

          path = "coolify.shared.env"
          data = []
          with open(path, "r", encoding="utf-8") as f:
            for raw in f.read().splitlines():
              line = raw.strip()
              if not line or line.startswith("#"):
                continue
              if "=" not in line:
                continue

              key, value = line.split("=", 1)

              # strip optional "export "
              key = re.sub(r"^export\s+", "", key).strip()

              # keep value as-is (no unquoting); Coolify handles literal values
              is_multiline = "\n" in value

              data.append({
                "key": key,
                "value": value,
                "is_preview": False,
                "is_literal": True,
                "is_multiline": is_multiline,
                "is_shown_once": False
              })

          payload = {"data": data}
          with open("coolify.bulk.json", "w", encoding="utf-8") as out:
            json.dump(payload, out, ensure_ascii=False)

          print(f"Prepared {len(data)} envs -> coolify.bulk.json")
          PY

      - name: Sync to all apps (via Coolify API)
        env:
          COOLIFY_URL: ${{ secrets.COOLIFY_URL }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_API_TOKEN }}
          COOLIFY_APP_UUIDS: dks88cs0k8cgogko8o488ogg # "uuid1 uuid2 uuid3 ..."
        run: |
          set -euo pipefail
          base="${COOLIFY_URL%/}/api/v1"

          # optional: show server version
          echo "Coolify version:"
          curl -sS -H "Authorization: Bearer $COOLIFY_TOKEN" "$base/version" || true
          echo

          for uuid in $COOLIFY_APP_UUIDS; do
            echo "Bulk syncing envs for app: $uuid"
            curl -sS -i -X PATCH \
              -H "Authorization: Bearer $COOLIFY_TOKEN" \
              -H "Content-Type: application/json" \
              --data @coolify.bulk.json \
              "$base/applications/$uuid/envs/bulk" \
              | sed -n '1,25p'
            echo
          done
