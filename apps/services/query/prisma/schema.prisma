generator client {
    provider      = "prisma-client"
    output        = "../src/generated/prisma-client"
    moduleFormat  = "cjs"
    binaryTargets = ["native", "debian-openssl-1.1.x"]
}

generator json {
    provider = "prisma-json-types-generator"
}

datasource db {
    provider = "postgresql"
}

// =================================================================================================

enum ProductStatus {
    ACTIVE
    INACTIVE
    BANNED
    DRAFT
}

model ProductView {
    id          String  @id
    name        String
    description String? @db.Text

    provinceId   Int
    provinceName String

    districtId   Int
    districtName String

    wardId   Int
    wardName String

    brandId   String?
    brandName String?
    brandLogo String?

    // Lưu mảng các Category ID để filter nhanh: WHERE categoryIds ?& ['cat_1']
    categoryIds String[]
    /// [Categories]
    categories  Json // Lưu chi tiết: [{id, name, slug}, ...] để hiển thị breadcrumb

    // Tính toán từ bảng SKU lúc sync dữ liệu sang đây
    basePrice    Float @default(0) // Giá gốc hiển thị
    virtualPrice Float @default(0) // Giá ảo hiển thị
    minPrice     Float @default(0) // Giá thấp nhất trong các SKU (để hiển thị "Từ 50k...")
    maxPrice     Float @default(0) // Giá cao nhất

    totalStock  Int     @default(0)
    isAvailable Boolean @default(true) // Tính toán: totalStock > 0 && status == ACTIVE

    images    String[]
    sizeGuide String?  @db.Text

    /// [Variants]
    variants Json

    /// [Attributes]
    attributes Json

    /// [Skus]
    skus Json

    reviewIds   String[]
    ratingCount Int      @default(0)
    averageRate Float    @default(0)
    soldCount   Int      @default(0)
    viewCount   Int      @default(0)
    likeCount   Int      @default(0)

    shopId     String
    status     ProductStatus
    isApproved Boolean       @default(false)
    isHidden   Boolean       @default(false)

    createdAt DateTime
    updatedAt DateTime

    @@index([shopId])
    @@index([brandId])
    @@index([minPrice, maxPrice]) // Index cho filter khoảng giá
    @@index([isAvailable]) // Index cho filter "Còn hàng"
    @@index([createdAt]) // Index cho sort "Mới nhất"
    @@index([soldCount]) // Index cho sort "Bán chạy"
    @@index([categoryIds]) // Index GIN cho mảng string (Postgres hỗ trợ tốt)
    @@index([name]) // Có thể thay bằng Full Text Search index
}

// Model này phục vụ Navigation Menu / Mega Menu
model CategoryView {
    id       String  @id
    name     String
    logo     String?
    parentId String?

    // Lưu path để query cây: "grandparent_id/parent_id"
    path  String?
    level Int     @default(0)

    createdAt DateTime
    updatedAt DateTime

    @@index([name])
    @@index([parentId])
    @@index([level])
}

model BrandView {
    id   String @id
    name String
    logo String @db.VarChar(1000)

    // Giúp sort brand "Hot nhất" mà không cần count bảng Product
    productCount Int @default(0) // Tổng số sản phẩm đang active
    soldCount    Int @default(0) // Tổng số lượng đã bán của brand này

    categoryIds String[]
    /// [Categories]
    categories  Json

    createdAt DateTime
    updatedAt DateTime

    @@index([soldCount(sort: Desc)]) // Query "Thương hiệu bán chạy"
    @@index([name]) // Search tên brand
}

model AttributeView {
    id   String  @id
    name String  @unique
    url  String?

    createdAt DateTime
    updatedAt DateTime

    @@index([name])
}

// =================================================================================================

enum NotificationType {
    ORDER_UPDATE
    PROMOTION
    WALLET_UPDATE
    TRUST_ME_BRO_UPDATE
}

model NotificationView {
    id     String @id
    userId String

    type        NotificationType
    title       String
    description String?          @db.Text
    link        String?
    image       String?

    /// [Metadata]
    metadata Json?

    isRead Boolean @default(false)

    createdAt DateTime
    updatedAt DateTime

    // Index Composite [userId + createdAt DESC] giúp query này cực nhanh, không cần sort lại
    @@index([userId, createdAt(sort: Desc)])
    // Query đếm badge: "User A có bao nhiêu noti chưa đọc?"
    @@index([userId, isRead])
    //(Optional) Nếu có tính năng lọc theo loại (Tab Khuyến mãi, Tab Đơn hàng...)
    @@index([userId, type, createdAt(sort: Desc)])
}

// =================================================================================================

enum VideoStatus {
    UPLOADING
    UPLOADED
    PROCESSING
    READY
    FAILED
    DELETED
}

model VideoView {
    id            String      @id
    storageBucket String
    storageKey    String
    filetype      String
    size          Int
    status        VideoStatus
    duration      Int         @default(0)
    width         Int         @default(0)
    height        Int         @default(0)

    createdAt DateTime
    updatedAt DateTime

    title String @default("")

    likeCount    Int @default(0)
    commentCount Int @default(0)

    authorId       String
    authorUsername String? @db.VarChar(200)
    authorAvatar   String? @db.VarChar(1000)

    @@index([status, createdAt])
    @@index([authorId, createdAt])
    @@index([storageKey])
}

model VideoViewerLike {
    id        String   @id @default(uuid())
    videoId   String
    userId    String
    liked     Boolean  @default(true)
    updatedAt DateTime @updatedAt

    @@unique([videoId, userId])
    @@index([userId, updatedAt])
    @@index([videoId])
}

// =================================================================================================
enum OrderStatus {
    CREATING // đang tạo đơn
    PENDING // chờ xác nhận
    CONFIRMED // đã xác nhận, đang chuẩn bị
    SHIPPING // đang giao
    COMPLETED // đã giao
    CANCELLED // đã hủy
    REFUNDED // đã hoàn tiền
}

enum PaymentMethod {
    COD
    WALLET
    ONLINE
}

enum PaymentStatus {
    PENDING
    SUCCESS
    FAILED
    REFUNDED
}

model OrderView {
    id   String @id
    code String @unique

    userId   String
    shopId   String
    shopName String

    status        OrderStatus   @default(PENDING)
    paymentMethod PaymentMethod
    paymentStatus PaymentStatus @default(PENDING)
    paymentId     String?

    itemTotal   Int @default(0)
    shippingFee Int @default(0)
    discount    Int @default(0)
    grandTotal  Int @default(0)

    /// [Receiver]
    receiver        Json
    receiverName    String
    receiverPhone   String
    receiverAddress String

    /// [Timeline]
    timeline Json

    /// [OrderItems]
    itemsSnapshot Json?

    firstProductName  String
    firstProductImage String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, createdAt(sort: Desc)])
    @@index([shopId, createdAt(sort: Desc)])
    @@index([status, createdAt(sort: Desc)])
    @@index([paymentStatus, createdAt(sort: Desc)])
    @@index([userId, status, createdAt(sort: Desc)])
    @@index([shopId, status, createdAt(sort: Desc)])
    @@index([status])
}
